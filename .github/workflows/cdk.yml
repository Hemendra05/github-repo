name: CDK deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    paths:
      - cdk/**

jobs:
  deploy:
    runs-on: ubuntu-latest
    container: hemendra05/aws-cdk
    steps:

      - name: Configure AWS credentials
        run: |
          export AWS_ROLE_ARN=arn:aws:iam::872436821098:role/ExampleGithubRole
          export AWS_WEB_IDENTITY_TOKEN_FILE=/tmp/awscreds
          export AWS_DEFAULT_REGION=ap-south-1

          echo AWS_WEB_IDENTITY_TOKEN_FILE=$AWS_WEB_IDENTITY_TOKEN_FILE >> $GITHUB_ENV
          echo AWS_ROLE_ARN=$AWS_ROLE_ARN >> $GITHUB_ENV
          echo AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION >> $GITHUB_ENV


      - uses: actions/checkout@v2

      - name: Login into AWS CodeArtifacts
        run: aws codeartifact login --tool pip --repository cdk_base_functions --domain myways-devops --domain-owner 872436821098

      - name: Installing requirements
        working-directory: ./cdk/
        run: pip install -r requirements.txt

      - name: Deploy the application
        working-directory: ./cdk/
        run: cdk synth